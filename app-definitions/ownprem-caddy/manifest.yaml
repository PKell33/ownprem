name: ownprem-caddy
displayName: Caddy
version: 2.8.4
category: system
description: Reverse proxy with automatic HTTPS

# System app flags
system: true
mandatory: true
singleton: false  # Can have multiple instances for HA

source:
  type: binary
  downloadUrl: https://github.com/caddyserver/caddy/releases/download/v2.8.4/caddy_2.8.4_linux_${ARCH}.tar.gz
  binaryName: caddy

requires:
  - service: ca-https
    locality: any-server
    description: Certificate Authority for TLS certificates

provides:
  - name: https-proxy
    port: 443
    protocol: https
    description: Main HTTPS entry point

  - name: http-redirect
    port: 80
    protocol: http
    description: HTTP to HTTPS redirect

  - name: caddy-admin
    port: 2019
    protocol: http
    internal: true
    description: Caddy Admin API

configSchema:
  - name: ca_url
    label: CA URL
    type: string
    default: "https://ca.ownprem.local:8443/acme/acme/directory"
    description: ACME directory URL for the internal CA

  - name: ca_root_cert
    label: CA Root Certificate Path
    type: string
    default: "/etc/step-ca/root_ca.crt"
    description: Path to CA root certificate for trust

  - name: admin_api_listen
    label: Admin API Listen Address
    type: string
    default: "localhost:2019"
    description: Address for Caddy Admin API

  # HA Configuration
  - name: ha_enabled
    label: Enable High Availability
    type: boolean
    default: false
    description: Enable VRRP failover with keepalived

  - name: ha_vip
    label: Virtual IP Address
    type: string
    showIf: ha_enabled
    description: Shared IP address for failover (e.g., 192.168.1.100)

  - name: ha_interface
    label: Network Interface
    type: string
    default: "eth0"
    showIf: ha_enabled
    description: Network interface for VIP

  - name: ha_priority
    label: VRRP Priority
    type: number
    default: 100
    showIf: ha_enabled
    description: Higher priority = preferred master (1-254)

  - name: ha_router_id
    label: VRRP Router ID
    type: number
    default: 51
    showIf: ha_enabled
    description: Unique ID for this VRRP group (1-255)

dataDirectories:
  - path: /var/lib/caddy
    description: Caddy data (certificates, ACME state)
  - path: /etc/caddy
    description: Caddy configuration

logging:
  serviceName: ownprem-caddy

serviceUser: caddy
serviceGroup: caddy

capabilities:
  - cap_net_bind_service=+ep
